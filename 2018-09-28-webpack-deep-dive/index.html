<!DOCTYPE html>
<html id="slides" lang="en">

<head>
  <meta charset="UTF-8">
  <title>Webpack deep dive</title>
  <link href="./styles/fonts.css" type="text/css" rel="stylesheet">
  <link href="./styles/main.css" type="text/css" rel="stylesheet">
</head>

<body class="slides">
  <textarea id="source">
    layout: true
    class: theme-whiskey, slides-left
    ---
    name: cover

    # Webpack deep dive

    Johannes Ewald<br>
    Peerigon GmbH<br>
    [@jhnnns](https://twitter.com/jhnnns)

    <img id="slide-cover-img" src="./assets/peerigon-logo.png" width="400">

    ---

    <img src="./assets/slide-2.svg" width="1200" style="position: absolute; top: 0; left: 0;">

    ---
    layout: true
    class: theme-whiskey, slides-centered
    ---

    <img src="./assets/peerigon-logo.png" width="500">

    ---

    <img src="./assets/webpack-logo.svg" width="600">

    ---

    ### 1. What is webpack?
    
    --

    ### 2. How does it work?

    --

    ### 3. How do you get the most out of it?

    ---
    class: slides-chapter

    ## What is webpack?

    ---
    layout: true
    class: slides-centered
    ---

    ### Webpack is just a module bundler which<br>turns a dependency graph into<br>an optimized chunk graph.

    ### <span style="visibility: hidden;">;)</span>

    ---

    ### Webpack is just a module bundler which<br>turns a dependency graph into<br>an optimized chunk graph.

    ### ;)

    ---

    ### Webpack is just a <span style="background: #46e1c8">module bundler</span> which<br>turns a dependency graph into<br>an optimized chunk graph.

    ### ;)

    ---

    ### Webpack is just a <span style="background: #46e1c8">module bundler</span> which<br>turns a <span style="background: #46e1c8">dependency graph</span> into<br>an optimized chunk graph.

    ### ;)

    ---

    ### Webpack is just a <span style="background: #46e1c8">module bundler</span> which<br>turns a <span style="background: #46e1c8">dependency graph</span> into<br>an <span style="background: #46e1c8">optimized chunk graph</span>.

    ### ;)

    ---

    ### <span style="opacity: 0.2">Webpack is just a </span><span style="background: #46e1c8">module bundler</span>

    ---

    ### Without a module bundler...

    .slides-content[
    .slides-columns[
    ```
    // message.js

    const message = "Hello World";

    printMessage();
    ```
    ```
    // printMessage.js

    function printMessage() {
      console.log(message);
    }
    ```
    ]

    - What if `message.js` is included before `printMessage.js`?
    - What if multiple files use the variable name `message`?
    ]

    ---

    ### Without a module bundler...

    .slides-content[
    - the `&lt;script>` order is important
    - top-level variables and functions are global

    As your application grows, this becomes a problem.
    ]

    ---

    .slides-content[
    To address this problem, the JavaScript community came up with a module system called **[AMD](https://en.wikipedia.org/wiki/Asynchronous_module_definition)**.

    <img src="assets/require-js.svg" height="200" style="display: block; margin: 4rem auto;"/>

    The most popular implementation of AMD is [require.js](https://requirejs.org/).
    ]

    ---

    .slides-content[
    ```
    define(






    );
    ```
    ]

    .slides-caption[
    require.js provides a global function `define()` which can be used to create a module.
    ]

    ---

    .slides-content[
    ```
    define(
      "a", // module id






    );
    ```
    ]

    .slides-caption[
    As first argument, `define()` takes a unique id for the module.
    ]

    ---

    .slides-content[
    ```
    define(
      "a", // module id
      ["b", "c"], // list of required modules





    );
    ```
    ]

    .slides-caption[
    As second argument, `define()` takes a list of module ids that are required by this module.<br>
    They need to be loaded beforehand.
    ]

    ---

    .slides-content[
    ```
    define(
      "a", // module id
      ["b", "c"], // list of required modules
      function (b, c) { // implementation
        // ...

      }
    );
    ```
    ]

    .slides-caption[
    As third argument, there is the actual implementation.<br>
    The **function wrapper** ensures that values inside the module can not be accessed from the outside.<br>
    Required modules are passed as argument to the function.
    ]

    ---

    .slides-content[
    ```
    define(
      "a", // module id
      ["b", "c"], // list of required modules
      function (b, c) { // implementation
        // ...
        return someValues; // optional exports
      }
    );
    ```
    ]

    .slides-caption[
    The module may export values for other modules as return value.<br>
    ]

    ---

    .slides-columns[
    ```
    define(
      "message.js",
      ["printMessage.js"],
      function (printMessage) {
        const message = "Hello World";

        printMessage();

        return message;
      }
    );
    ```
    ```
    define(
      "printMessage.js",
      ["message.js"],
      function (message) {
        function printMessage() {
          console.log(message);
        }

        return printMessage;
      }
    );
    ```
    ]

    .slides-caption[
    Example as AMD module.
    ]

    ---

    .slides-columns[
    ```
    define(
      "message.js",
      ["printMessage.js"],
      function (printMessage) {
        const message = "Hello World";

        printMessage();

        return message;
      }
    );
    ```
    ```
    define(
      "printMessage.js",
      ["message.js"],
      function (message) {
        function printMessage() {
          console.log(message);
        }

        return printMessage;
      }
    );
    ```
    ]

    .slides-caption[
    This example would not execute properly because
    it has a **cyclic dependency**:<br>
    `message.js` requires `printMessage.js` which requires `message.js`.
    ]

    ---

    .slides-columns[
    ```
    define(
      "message.js",
      ["printMessage.js"],
      function (printMessage) {
        const message = "Hello World";

        printMessage(); // <-- execute

        return message; // <--- export
      }
    );
    ```
    ```
    define(
      "printMessage.js",
      ["message.js"],
      function (message) {
        function printMessage() {
          console.log(message);
        }

        return printMessage;
      }
    );
    ```
    ]

    .slides-caption[
    `message.js` does two things:

    - execute side-effect `printMessage`
    - export `message`
    ]

    ---

    .slides-columns[
    ```
    define(
      "message.js",
      [],
      function () {
        const message = "Hello World";

        return message;
      }
    );
    ```
    ```
    define(
      "printMessage.js",
      ["message.js"],
      function (message) {
        function printMessage() {
          console.log(message);
        }

        return printMessage;
      }
    );
    ```
    ```
    define(
      "main.js",
      ["printMessage.js"],
      function (printMessage) {
        printMessage();
      }
    );
    ```
    ]

    .slides-caption[
    Implementation without cyclic dependency:

    - module `message.js` exports value `message`
    - module `main.js` executes `printMessage`
    ]

    ---

    Drawn as a diagram:

    <img src="assets/dep-graph-amd.svg" width="500" />

    ---

    ```html
    <script data-main="main.js" src="require.js"></script>
    ```

    .slides-caption[
    To execute this code with require.js, we point it<br>
    to our `main.js` module via the `data-main` attribute.
    ]

    ---

    <div style="width: 250px; height: 64px; background: url(assets/dep-graph-amd.svg); background-size: 500px; background-position: -250px -339px;"></div>

    .slides-caption[
    require.js starts to **resolve** all required dependencies by executing each `define()`
    ]

    ---

    <div style="width: 250px; height: 167px; background: url(assets/dep-graph-amd.svg); background-size: 500px; background-position: -250px -226px;"></div>

    .slides-caption[
    Dependencies are loaded **asynchronously** from the server.
    ]

    ---

    <div style="width: 250px; height: 306px; background: url(assets/dep-graph-amd.svg); background-size: 500px; background-position: -250px -97px;"></div>

    .slides-caption[
    And so on.
    ]

    ---

    <div style="width: 250px; height: 306px; background: url(assets/dep-graph-amd.svg); background-size: 500px; background-position: -250px -97px;"></div>

    .slides-caption[
    Once all dependencies have been resolved, it starts to **evaluate** each module function wrapper from top to bottom.
    ]

    ---

    <div style="width: 250px; height: 306px; background: url(assets/dep-graph-amd.svg); background-size: 500px; background-position: -250px -97px;">
      <div style="height: 65px; background: url(assets/dep-graph-amd.svg); background-size: 500px; background-position: -250px -97px;">
        <div style="height: 100%; background: #2f1e1c; mix-blend-mode: hue"></div>
      </div>
    </div>

    .slides-caption[
    Once all dependencies have been resolved, it starts to **evaluate** each module function wrapper from top to bottom.
    ]

    ---

    <div style="width: 250px; height: 306px; background: url(assets/dep-graph-amd.svg); background-size: 500px; background-position: -250px -97px;">
      <div style="height: 180px; background: url(assets/dep-graph-amd.svg); background-size: 500px; background-position: -250px -97px;">
        <div style="height: 100%; background: #2f1e1c; mix-blend-mode: hue"></div>
      </div>
    </div>

    .slides-caption[
    Once all dependencies have been resolved, it starts to **evaluate** each module function wrapper from top to bottom.
    ]

    ---

    <div style="width: 250px; height: 306px; background: url(assets/dep-graph-amd.svg); background-size: 500px; background-position: -250px -97px;">
      <div style="height: 100%; background: #2f1e1c; mix-blend-mode: hue"></div>
    </div>

    .slides-caption[
    Once all dependencies have been resolved, it starts to **evaluate** each module function wrapper from top to bottom.
    ]

    ---

    <img src="assets/dep-graph-amd-interleaved.svg" height="400" />

    .slides-caption[
    Both steps—resolve and evaluate—*can* be interleaved.
    ]

    ---

    .slides-content[
    <img src="assets/nodejs-logo.jpg" width="400" style="margin: auto"/>

    Roughly at the same time, Node.js came up with a different module system called **CommonJS**.
    ]

    ---

    .slides-columns[
    ```
    // message.js
    const message = "Hello World";

    module.exports = message;
    ```
    ```
    // printMessage.js
    const message =
      require("./message.js");

    function printMessage() {
      console.log(message);
    }

    module.exports = printMessage;
    ```
    ```
    // main.js
    const printMessage =
      require("./printMessage.js");

    printMessage();
    ```
    ]

    .slides-caption[
    Example as CommonJS module.
    ]

    ---

    <div style="width: 250px; height: 64px; background: url(assets/dep-graph-cjs.svg); background-size: 278px; background-position: 0 -298px;"></div>

    .slides-caption[
    Node.js starts to **evaluate** the first module.<br>
    ]

    ---

    <div style="width: 250px; height: 200px; background: url(assets/dep-graph-cjs.svg); background-size: 278px; background-position: 0 -159px;"></div>

    .slides-caption[
    Calling `require()` stops the current evaluation, loads the required module **synchronously** from the file system and **evaluates** it.<br>
    ]

    ---

    <div style="width: 250px; height: 340px; background: url(assets/dep-graph-cjs.svg); background-size: 278px; background-position: 0 -19px;"></div>

    .slides-caption[
    And so on.
    ]

    ---

    <div style="width: 250px; height: 340px; background: url(assets/dep-graph-cjs.svg); background-size: 278px; background-position: 0 -19px;">
      <div style=" height: 77px; background: url(assets/dep-graph-cjs-evaluated.svg); background-size: 278px; background-position: 0 -19px;"></div>
    </div>

    .slides-caption[
    Once all dependencies have been resolved, the evaluation stack unwinds like a callstack<br>(because it *is* a callstack).
    ]

    ---

    <div style="width: 250px; height: 340px; background: url(assets/dep-graph-cjs.svg); background-size: 278px; background-position: 0 -19px;">
      <div style=" height: 237px; background: url(assets/dep-graph-cjs-evaluated.svg); background-size: 278px; background-position: 0 -19px;"></div>
    </div>

    .slides-caption[
    Once all dependencies have been resolved, the evaluation stack unwinds like a callstack<br>(because it *is* a callstack).
    ]

    ---

    <div style="width: 250px; height: 340px; background: url(assets/dep-graph-cjs.svg); background-size: 278px; background-position: 0 -19px;">
      <div style=" height: 340px; background: url(assets/dep-graph-cjs-evaluated.svg); background-size: 278px; background-position: 0 -19px;"></div>
    </div>

    .slides-caption[
    Once all dependencies have been resolved, the evaluation stack unwinds like a callstack<br>(because it *is* a callstack).
    ]

    ---

    .slides-content[
    Node.js achieves the module scope by wrapping each source file into a function wrapper before evaluating it:

    ```
    (function (exports, require, module, __filename, __dirname) {

    /* YOUR CODE */

    })(module.exports, require, module, filename, dirname);
    ```
    ]

    ---

    .slides-content[
    <img src="assets/npm-logo.svg" height="150" style="margin: auto" />

    Due to Node.js' popularity, a lot of JavaScript is published as CommonJS on [NPM](https://www.npmjs.com/).
    ]

    ---

    ### Two notes on CommonJS

    ---

    #### 1.

    .slides-content[
    CommonJS allow dynamic imports...

    ```
    const locale = require("./locales/" + language);
    ```

    ...or dynamic exports...

    ```
    if (Math.random() < 0.5) {
      module.exports.hello = true;
    } else {
      module.exports.world = true;
    }
    ```
    ]

    ---

    #### 2.

    .slides-content[
    CommonJS was invented for server-side JavaScript.

    It requires the modules to be loaded synchronously which is impractical for the browser.
    ]

    ---

    Two incompatible module systems emerged...

    ---

    <img src="assets/xkcd-standards.png" width="500" />

    .slides-footnote[
    https://xkcd.com/927/
    ]

    ---

    .slides-content[
    <img src="assets/js-logo.svg" height="200" style="margin: auto" />

    As a response, ECMAScript 2015 introduced a native module syntax: the ECMAScript module (ESM).
    ]

    ---

    .slides-content[
    ```
    // message.js
    export const message = "Hello World";
    ```
    ```
    // printMessage.js
    import {message} from "./message.js";

    export function printMessage() {
      console.log(message);
    }
    ```
    ```
    // main.js
    import {printMessage} from "./printMessage.js";

    printMessage();
    ```
    ]

    .slides-caption[
    Example as ESM.
    ]

    ---

    The ESM can be loaded by modern browsers via:

    ```html
    <script type="module" src="main.js"></script>
    ```

    ---

    ### Four notes about ESMs

    ---

    #### 1.

    <img src="assets/esm-spec.jpg" height="300" style="margin: 3rem" />

    .slides-caption[
    The [specification](http://www.ecma-international.org/ecma-262/6.0/#sec-hostresolveimportedmodule) leaves the actual module resolution up to implementation.
    ]

    ---

    #### 2.

    .slides-content[
    The order of evaluation is mostly unspecified.

    The only guarantee: all dependencies must have been evaluated before the module itself is evaluated.
    ]

    ---

    #### 3.

    .slides-content[
    ESMs imports are **live bindings**:

    .slides-columns[
    .col[
    ```
    export let message = "hello"

    setTimeout(() => {
      message = "world";
    }, 1000);
    ```
    ]
    .col[
    ```
    import {message} from "./message.js";

    console.log(message); // "hello"
    
    setTimeout(() => {
      console.log(message); // "world"
    }, 2000)
    ```
    ]
    ]
    ]

    ---

    #### 3.

    .slides-content[
    Compare with CommonJS:

    .slides-columns[
    .col[
    ```
    let message = "hello";

    module.exports = message;

    setTimeout(() => {
      message = "world";
    }, 1000);
    ```
    ]
    .col[
    ```
    const message = require("./message.js");

    console.log(message); // "hello"

    setTimeout(() => {
      console.log(message); // "hello"
    }, 2000)
    ```
    ]
    ]
    ]

    ---

    #### 4.

    .slides-content[
    The module syntax guarantees that module imports and exports are statically analyzable.

    ```
    import {locale} from "./locales/" + language; // <--- SyntaxError
    ```
    ]

    ---

    ### Comparison

    .slides-content[
    &nbsp; | AMD | CommonJS | ESM
    :------|:----|:---------|:---
    **Analyzable** | With limitations | With limitations | Yes
    **Resolving** | Asynchronous | Synchronous | Unspecified
    **Linking** | Copy by value | Copy by value | Live binding
    **Scoping** | Function&nbsp;wrapper | Function&nbsp;wrapper | New language environment
    **Evaluation order** | I/O dependent | Execution dependent | Mostly unspecified
    ]

    ---

    Interoperability is a mess.

    <img src="assets/man-crying.gif" width="400" />
    <small style="position: relative; top: -1.5rem;"><a href="https://twitter.com/bradleymeck">@bradleymeck</a> implementing ESMs for Node.js</small>

    ---

    .slides-content[
    And there's an additional problem:

    All three module systems are slow to initialize when a lot of modules need to be loaded.
    ]

    ---

    .slides-content[
    This is due to the **roundtrip problem**:

    <div style="background-image: url(assets/roundtrip.svg); width: 362px; height: 380px; background-size: 100%; background-position: 0 -46px; margin: auto"></div>
    ]

    ---

    ### Module bundlers to the rescue!

    .slides-columns[
    <img src="assets/browserify-logo.png" height="100">
    <img src="assets/webpack-logo.svg" height="120">
    ]

    .slides-columns[
    <img src="assets/rollup-logo.png" height="100">
    <img src="assets/parcel-logo.png" height="100">
    ]

    ---

    Module bundlers...

    ...**analyze JavaScript modules** by reading their source code...<br>
    ...to generate **compatible JavaScript files** (bundle).

    ---

    Module bundlers leverage the fact that all<br>module systems share the same **mental model**:

    - A module has a **unique id**
    - Modules reference other modules<br>as dependency via **specifiers**
    - A module specifier can be resolved to a module id

    ---

    This model is called the **dependency graph**.

    ---

    A dependency graph can be simple...

    <img src="assets/dep-graph-simple.svg" height="450">

    ---

    ...or complex...

    <img src="assets/dep-graph-complex.png" height="450">

    ---

    ...or **very** complex.

    <img src="assets/dep-graph-very-complex.png" height="450">

    ---

    Module bundlers...

    ...try to do as much as possible **on build time**...<br>
    ...so that there's less to do **on runtime**.

    ---

    ### <span style="opacity: 0.2">Webpack is just a </span><span style="background: #46e1c8">module bundler</span> <span style="opacity: 0.2">which<br>turns a </span><span style="background: #46e1c8">dependency graph</span> <span style="opacity: 0.2">into<br>an optimized chunk graph.</span>

    ---

    .slides-content[
    .slides-label[Take away]

    Modules allow us to structure the
    application code in a meaningful way
    by separating things that should stay separate.
    
    **It's a good idea to separate *definition* from *execution*.**
    ]

    ---

    TODO: Good module patterns (no import *, no side-effects)

    asd

</textarea>
  <script src="./js/remark/remark.js" type="text/javascript"></script>
  <script type="text/javascript">
    var slideshow = remark.create({
      highlightStyle: "ir_black",
      highlightLanguage: "javascript",
      ratio: "16:9",
    });
  </script>
</body>

</html>